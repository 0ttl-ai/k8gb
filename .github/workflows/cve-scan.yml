name: Daily CVE Scan

on:
  schedule:
    # Run daily at 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch: # Allow manual triggering

permissions:
  contents: read
  pull-requests: write

jobs:
  cve-scan:
    name: Scan k8gb for CVEs (branch ${{ matrix.branch }})
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        branch:
          - maintain/v0.15.0
          - maintain/v0.16.0
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5.0.1 #93cb6efe18208431cddfb8368fd83d5badbf9bfd
        with:
          ref: ${{ matrix.branch }}

      - name: Setup go
        uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00 # v6.0.0
        with:
          go-version-file: ./go.mod

      - name: Build artifacts
        uses: goreleaser/goreleaser-action@e435ccd777264be153ace6237001ef4d979d3a7a # v6.4.0
        with:
          version: v1.9.2
          args: release --rm-dist --skip-publish --skip-validate --snapshot --skip-sbom --skip-sign
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get release from branch name
        id: get-release
        run: |
          RELEASE="${{ matrix.branch }}"
          RELEASE="${RELEASE#*/}" # Remove everything up to first /
          echo "release=$RELEASE" >> $GITHUB_OUTPUT
          SHA="$(git rev-parse --short=7 HEAD)"
          echo "sha=$SHA" >> $GITHUB_OUTPUT
          echo "Release from branch name: $RELEASE"
          echo "Branch commit SHA: $SHA"
    
      - name: Scan container image with Trivy in table format
        continue-on-error: true
        uses: aquasecurity/trivy-action@0.33.1 #b6643a29fecd7f34b3597bc6acb0a98b03d33ff8
        with:
          version: v0.67.2
          image-ref: 'docker.io/absaoss/k8gb:v0.0.0-${{ steps.get-release.outputs.sha }}-amd64'
          format: 'table'
          exit-code: '0' # Don't fail on vulnerabilities
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'

      - name: Scan container image with Trivy in SARIF format
        id: scan-image-sarif
        continue-on-error: true
        uses: aquasecurity/trivy-action@0.33.1 #b6643a29fecd7f34b3597bc6acb0a98b03d33ff8
        with:
          version: v0.67.2
          image-ref: 'docker.io/absaoss/k8gb:v0.0.0-${{ steps.get-release.outputs.sha }}-amd64'
          format: 'sarif'
          output: 'trivy-image-results.sarif'
          exit-code: '0' # Don't fail on vulnerabilities
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'

      - name: Upload container image scan results as artifact
        if: always() && steps.scan-image-sarif.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: trivy-image-scan-results-${{ steps.get-release.outputs.release }}
          path: trivy-image-results.sarif
          retention-days: 30

    #   - name: Clone k8gb repository
    #     run: |
    #       git clone --depth 1 --branch ${{ steps.get-release.outputs.release }} https://github.com/k8gb-io/k8gb.git k8gb-repo || \
    #       git clone --depth 1 https://github.com/k8gb-io/k8gb.git k8gb-repo

    #   - name: Scan Helm chart with Trivy
    #     id: scan-helm
    #     continue-on-error: true
    #     uses: aquasecurity/trivy-action@0.33.1 #b6643a29fecd7f34b3597bc6acb0a98b03d33ff8
    #     with:
    #       version: v0.67.2
    #       scan-type: 'config'
    #       scan-ref: 'k8gb-repo/chart/k8gb'
    #       format: 'sarif'
    #       output: 'trivy-helm-results.sarif'
    #       exit-code: '0' # Don't fail on vulnerabilities
    #       severity: 'CRITICAL,HIGH,MEDIUM,LOW'

    #   - name: Display Helm chart scan summary
    #     if: always() && steps.scan-helm.outcome == 'success'
    #     continue-on-error: true
    #     uses: aquasecurity/trivy-action@0.33.1 #b6643a29fecd7f34b3597bc6acb0a98b03d33ff8
    #     with:
    #       version: v0.67.2
    #       scan-type: 'config'
    #       scan-ref: 'k8gb-repo/chart/k8gb'
    #       format: 'table'
    #       exit-code: '0' # Don't fail on vulnerabilities
    #       severity: 'CRITICAL,HIGH,MEDIUM,LOW'

    #   - name: Upload Helm chart scan results as artifact
    #     if: always() && steps.scan-helm.outcome == 'success'
    #     uses: actions/upload-artifact@v4
    #     with:
    #       name: trivy-helm-scan-results-${{ matrix.branch }}
    #       path: trivy-helm-results.sarif
    #       retention-days: 30
