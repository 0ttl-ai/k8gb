name: Daily CVE Scan

on:
  schedule:
    # Run daily at 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch: # Allow manual triggering

permissions:
  contents: read
  pull-requests: write

jobs:
  cve-scan:
    name: Scan k8gb for CVEs (branch ${{ matrix.branch }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        branch:
          - maintain/v0.15.0
          - maintain/v0.16.0
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5.0.1 #93cb6efe18208431cddfb8368fd83d5badbf9bfd
        with:
          ref: ${{ matrix.branch }}

      - name: Get latest k8gb release
        id: get-release
        run: |
          LATEST_RELEASE=$(curl -s https://api.github.com/repos/k8gb-io/k8gb/releases/latest | jq -r '.tag_name')
          echo "latest_release=$LATEST_RELEASE" >> $GITHUB_OUTPUT
          echo "Latest k8gb release: $LATEST_RELEASE"

      - name: Scan container image with Trivy
        id: scan-image
        continue-on-error: true
        uses: aquasecurity/trivy-action@0.33.1 #b6643a29fecd7f34b3597bc6acb0a98b03d33ff8
        with:
          version: v0.67.2
          image-ref: 'docker.io/absaoss/k8gb:${{ steps.get-release.outputs.latest_release }}'
          format: 'sarif'
          output: 'trivy-image-results.sarif'
          exit-code: '0' # Don't fail on vulnerabilities
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'

      - name: Generate JSON output for PR comment
        if: github.event_name == 'pull_request' && always() && steps.scan-image.outcome == 'success'
        continue-on-error: true
        uses: aquasecurity/trivy-action@0.33.1 #b6643a29fecd7f34b3597bc6acb0a98b03d33ff8
        with:
          version: v0.67.2
          image-ref: 'docker.io/absaoss/k8gb:${{ steps.get-release.outputs.latest_release }}'
          format: 'json'
          output: 'trivy-image-results.json'
          exit-code: '0' # Don't fail on vulnerabilities
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'

      - name: Display container image scan summary
        if: always() && steps.scan-image.outcome == 'success'
        continue-on-error: true
        uses: aquasecurity/trivy-action@0.33.1 #b6643a29fecd7f34b3597bc6acb0a98b03d33ff8
        with:
          version: v0.67.2
          image-ref: 'docker.io/absaoss/k8gb:${{ steps.get-release.outputs.latest_release }}'
          format: 'table'
          exit-code: '0' # Don't fail on vulnerabilities
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'

      - name: Upload container image scan results as artifact
        if: always() && steps.scan-image.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: trivy-image-scan-results-${{ matrix.branch }}
          path: trivy-image-results.sarif
          retention-days: 30

      - name: Post container scan results as PR comment
        if: github.event_name == 'pull_request' && always() && steps.scan-image.outcome == 'success'
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Read the JSON results
            let results;
            try {
              const jsonPath = 'trivy-image-results.json';
              if (!fs.existsSync(jsonPath)) {
                console.log('No JSON results file found, skipping comment');
                return;
              }
              results = JSON.parse(fs.readFileSync(jsonPath, 'utf8'));
            } catch (error) {
              console.log('Error reading results:', error.message);
              return;
            }
            
            // Count vulnerabilities by severity
            const severityCounts = { CRITICAL: 0, HIGH: 0, MEDIUM: 0, LOW: 0, UNKNOWN: 0 };
            const vulnerabilities = [];
            
            if (results.Results) {
              results.Results.forEach(result => {
                if (result.Vulnerabilities) {
                  result.Vulnerabilities.forEach(vuln => {
                    const severity = vuln.Severity || 'UNKNOWN';
                    severityCounts[severity] = (severityCounts[severity] || 0) + 1;
                    if (severity === 'CRITICAL' || severity === 'HIGH') {
                      vulnerabilities.push({
                        id: vuln.VulnerabilityID,
                        severity: severity,
                        package: vuln.PkgName,
                        version: vuln.InstalledVersion,
                        title: vuln.Title || vuln.VulnerabilityID,
                        description: vuln.Description || ''
                      });
                    }
                  });
                }
              });
            }
            
            // Build the comment
            const total = Object.values(severityCounts).reduce((a, b) => a + b, 0);
            let comment = '## ðŸ” Container Image Security Scan Results\n\n';
            comment += `**Image:** \`docker.io/absaoss/k8gb:${{ steps.get-release.outputs.latest_release }}\`\n\n`;
            comment += `**Total Vulnerabilities:** ${total}\n\n`;
            comment += '### Summary by Severity\n\n';
            comment += '| Severity | Count |\n';
            comment += '|----------|-------|\n';
            comment += `| ðŸ”´ CRITICAL | ${severityCounts.CRITICAL || 0} |\n`;
            comment += `| ðŸŸ  HIGH | ${severityCounts.HIGH || 0} |\n`;
            comment += `| ðŸŸ¡ MEDIUM | ${severityCounts.MEDIUM || 0} |\n`;
            comment += `| ðŸŸ¢ LOW | ${severityCounts.LOW || 0} |\n`;
            comment += `| âšª UNKNOWN | ${severityCounts.UNKNOWN || 0} |\n\n`;
            
            if (vulnerabilities.length > 0) {
              comment += '### ðŸ”´ Critical & High Severity Vulnerabilities\n\n';
              comment += '| CVE ID | Severity | Package | Version |\n';
              comment += '|--------|----------|---------|----------|\n';
              vulnerabilities.slice(0, 20).forEach(vuln => {
                const severityEmoji = vuln.severity === 'CRITICAL' ? 'ðŸ”´' : 'ðŸŸ ';
                comment += `| ${vuln.id} | ${severityEmoji} ${vuln.severity} | ${vuln.package} | ${vuln.version} |\n`;
              });
              if (vulnerabilities.length > 20) {
                comment += `\n*... and ${vulnerabilities.length - 20} more critical/high vulnerabilities*\n`;
              }
            }
            
            comment += '\n---\n';
            comment += '*ðŸ“¥ Download detailed SARIF results from workflow artifacts*\n';
            
            // Post the comment
            const prNumber = context.payload.pull_request?.number || context.issue.number;
            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Clone k8gb repository
        run: |
          git clone --depth 1 --branch ${{ steps.get-release.outputs.latest_release }} https://github.com/k8gb-io/k8gb.git k8gb-repo || \
          git clone --depth 1 https://github.com/k8gb-io/k8gb.git k8gb-repo

      - name: Scan Helm chart with Trivy
        id: scan-helm
        continue-on-error: true
        uses: aquasecurity/trivy-action@0.33.1 #b6643a29fecd7f34b3597bc6acb0a98b03d33ff8
        with:
          version: v0.67.2
          scan-type: 'config'
          scan-ref: 'k8gb-repo/chart/k8gb'
          format: 'sarif'
          output: 'trivy-helm-results.sarif'
          exit-code: '0' # Don't fail on vulnerabilities
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'

      - name: Display Helm chart scan summary
        if: always() && steps.scan-helm.outcome == 'success'
        continue-on-error: true
        uses: aquasecurity/trivy-action@0.33.1 #b6643a29fecd7f34b3597bc6acb0a98b03d33ff8
        with:
          version: v0.67.2
          scan-type: 'config'
          scan-ref: 'k8gb-repo/chart/k8gb'
          format: 'table'
          exit-code: '0' # Don't fail on vulnerabilities
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'

      - name: Upload Helm chart scan results as artifact
        if: always() && steps.scan-helm.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: trivy-helm-scan-results-${{ matrix.branch }}
          path: trivy-helm-results.sarif
          retention-days: 30
